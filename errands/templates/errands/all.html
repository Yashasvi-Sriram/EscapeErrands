{% extends 'home/__base__.html' %}
{% block title %}Errands{% endblock %}
{% block style %}
    <style>

        #errands_list .delete-btn i {
            margin-left: 10px;
            margin-right: 10px;
        }

        #errands_list .edit-btn i {
            margin-left: 10px;
            margin-right: 10px;
        }

        #errands_list .tag {
            margin-left: 10px;
        }

        #errands_list .delete-btn:hover {
            background-color: rgba(255, 0, 0, 0.4);
        }

        #errands_list .edit-btn:hover {
            background-color: rgba(0, 255, 128, 0.4);
        }

        #errands_list .collapsible-header:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }
    </style>
{% endblock %}
{% block body %}
    <!--suppress JSUnresolvedVariable -->
    {% load staticfiles %}
    <script src="{% static "errands/js/html_build_strings.js" %}"></script>
    <!--suppress JSUnresolvedVariable -->
    <script>

        function to_hrs(obj) {
            return obj.days * 24 + obj.seconds / 3600;
        }

        function to_days(obj) {
            return obj.days;
        }

        $(document).ready(function () {

            {# Listeners #}
            {# Remove btn #}
            $('.delete-btn')
                .on(
                    'click',
                    function () {
                        var that = $(this).parent().parent();
                        $(that).fadeOut(100, function () {
                            $(that).find('.delete_fm').submit();
                        });
                    }
                );

            {# Fetch and Render Errand #}
            $('#errands_list')
                .on(
                    'click',
                    '.expand',
                    function () {
                        var $li_parent = $(this).parent().parent().parent().parent();
                        // opening
                        var id = $($li_parent).attr('id');

                        $($li_parent).find('.preloader').fadeIn(0, function () {
                                $.ajax({
                                    url: '/errands/fetch_errand/' + id + '/',
                                    error: function () {
                                        alert('Errand could not be fetched!');
                                    },
                                    success: function (result) {
                                        // fetched
                                        var errand = JSON.parse(result);
                                        console.log(errand);
                                        // rendering
                                        var pieces_list = $($li_parent).find('.pieces');
                                        $(pieces_list).empty();
                                        for (var i = 0; i < errand.pieces.length; ++i) {
                                            var piece = errand.pieces[i];
                                            var piece_id = 'p' + piece.pk;
                                            var piece_duration = to_hrs(piece.duration);
                                            var piece_time_period = to_days(piece.time_period);
                                            $(pieces_list).append(HTML_STRINGS.ALL.PIECE(piece_id));
                                        }
                                        $($li_parent).find('.preloader').fadeOut(1000);
                                    }
                                });
                            }
                        );
                    }
                );

        })
    </script>
    <div class="row">
        <div class="col l2 m0 s0"></div>

        <div class="col l8 m12 s12">
            <div>
                <h4 class="teal-text">{{ errands|length }} Errand{% if errands|length > 1 %}s{% endif %}</h4>
                <ul id="errands_list" class="collapsible" data-collapsible="accordion">

                    {% for i in errands %}

                        <li id="{{ i.pk }}">

                            <div class="collapsible-header">
                                <span class="badge">
                                    {{ forloop.counter }}
                                </span>
                                <a class="waves-effect waves-red delete-btn">
                                    <i class="material-icons">delete</i>
                                </a>
                                <form class="delete_fm" method="post" action="{% url 'errands:delete' %}"
                                      style="display: none">
                                    {% csrf_token %}
                                    {# Delete Form Btn #}
                                    <input hidden name="pk" value="{{ i.pk }}">
                                </form>
                                <a href="{% url 'errands:touch' i.pk %}"
                                   class="waves-effect waves-yellow edit-btn">
                                    <i class="material-icons">mode_edit</i>
                                </a>

                                <span class="blue-text">
                                    <span class="tag">{{ i.tag }}</span>
                                </span>
                            </div>

                            <div class="collapsible-body">
                                <div class="row" style="margin: 0;position:relative;">
                                    {# Comment #}
                                    <code class="truncate comment"
                                          style="padding: 20px;min-height: 60px">
                                        {{ i.comment }}
                                    </code>
                                    {# Import Pieces Button #}
                                    <span style="position: absolute;right: 0;top: 0;padding: 10px;z-index: 10">
                                        <a href="#" class="btn-floating waves-effect z-depth-1 white expand"><i
                                                class="material-icons blue-text">sync</i></a>
                                    </span>
                                    {# Preloader #}
                                    <div class="preloader" style="position: absolute;right: 0;top: 0;padding: 12px;z-index: 11;display: none">
                                        <div class="preloader-wrapper active small">
                                            <div class="spinner-layer spinner-blue-only">
                                                <div class="circle-clipper left">
                                                    <div class="circle"></div>
                                                </div>
                                                <div class="gap-patch">
                                                    <div class="circle"></div>
                                                </div>
                                                <div class="circle-clipper right">
                                                    <div class="circle"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {# Pieces Table #}
                                    <table class="centered highlight" style="max-height: 500px">
                                        <tbody class="pieces">

                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </li>
                    {% endfor %}
                </ul>
            </div>
        </div>

        <div class="col l2 m0 s0">
            <div class="fixed-action-btn">
                <a href="{% url 'errands:touch' 0 %}"
                   class="btn-floating btn-large waves-effect waves-light pink z-depth-5">
                    <i class="material-icons">add</i>
                </a>
            </div>
        </div>
    </div>
{% endblock %}